<!-- app/templates/app/tweet_detail.html -->

{% extends 'app/base.html' %}

{% block content %}
    <h2>
        <a href="{% url 'app:user_profile' tweet.author.username %}">{{ tweet.author.username }}</a>
    </h2>
    <p>{{ tweet.content }}</p>
    {% if tweet.created_at %}
        <p>{{ tweet.created_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}</p>
    {% else %}
        <p>æ—¥ä»˜ã‘ãŒã‚ã‚Šã¾ã›ã‚“</p>
    {% endif %}
    
    {% if user == tweet.author %}
        <a href="{% url 'app:tweet_edit' tweet.pk %}">ç·¨é›†</a>
        <a href="{% url 'app:tweet_delete' tweet.pk %}">å‰Šé™¤</a>
    {% endif %}
    
    {% if user.is_authenticated %}
        <button id="like-button" class="like-button {% if is_liked %}liked{% endif %}">
            {% if is_liked %}
                â¤ï¸
            {% else %}
                ğŸ¤
            {% endif %}
            <span id="like-count">{{ like_count }}</span>
        </button>
    {% else %}
        <p>ã„ã„ã­ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
    {% endif %}

    <section class="comment-index">
        <h2>ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§</h2>
            {% if comment %}
                <ul class="comment-list">
                    {% for comment in comments %}
                        <li class="comment">
                            <p>{{ comment.user.username }}</p>
                            <p>{{ comment.content }}</p>
                            <p>{{ comment.created_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}</p>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endif %}
    </section>

    <!-- CSRFãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒ„ã‚¤ãƒ¼ãƒˆIDã‚’JavaScriptã«æ¸¡ã™ -->
    <script>
        const csrfToken = '{{ csrf_token }}';
        const likeToggleUrl = "{% url 'app:like_toggle' tweet.pk %}";
    </script>

    <!-- ã„ã„ã­æ©Ÿèƒ½ã®JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const likeButton = document.getElementById('like-button');
            const likeCount = document.getElementById('like-count');

            if (likeButton) {
                likeButton.addEventListener('click', () => {
                    fetch(likeToggleUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if(data.liked){
                            likeButton.innerHTML = 'â¤ï¸ <span id="like-count">' + data.like_count + '</span>';
                        } else {
                            likeButton.innerHTML = 'ğŸ¤ <span id="like-count">' + data.like_count + '</span>';
                        }
                    })
                    .catch(error => console.error('Error:', error));
                });
            }
        });
    </script>
{% endblock %}